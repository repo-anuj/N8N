{
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "triggerAtHour": 16,
              "triggerAtMinute": 0
            }
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        -992,
        -160
      ],
      "id": "node-schedule-trigger",
      "name": "Schedule Trigger"
    },
    {
      "parameters": {
        "url": "https://dev.to/api/articles?top=3",
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -672,
        -304
      ],
      "id": "node-devto-get-top",
      "name": "DevTo - Get Top Articles"
    },
    {
      "parameters": {
        "jsCode": "// items[0].json is expected to be an array of top articles\nconst articles = items[0].json;\nif (!Array.isArray(articles)) {\n  throw new Error('Dev.to response not an array');\n}\n// Map to uniform shape and keep top 3\nconst out = articles.slice(0,3).map(a => ({\n  source: 'devto',\n  title: a.title || a.name || '',\n  description: a.description || a.excerpt || '',\n  url: a.url || a.canonical_url || a.path || '',\n  tags: a.tag_list || a.tags || [],\n  body_markdown: a.body_markdown || ''\n}));\nreturn out.map(i => ({ json: i }));\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -384,
        -320
      ],
      "id": "node-pick-top-devto",
      "name": "PickTopArticles (Dev.to)"
    },
    {
      "parameters": {
        "url": "https://serpapi.com/search",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "q",
              "value": "=ai agents"
            },
            {
              "name": "geo",
              "value": "world"
            },
            {
              "name": "hl",
              "value": "en"
            },
            {
              "name": "date",
              "value": "={{ $now.minus({ days: 3 }).format('yyyy-MM-dd') }} {{ $now.format('yyyy-MM-dd') }}"
            },
            {
              "name": "data_type",
              "value": "RELATED_QUERIES"
            },
            {
              "name": "engine",
              "value": "google_trends"
            },
            {
              "name": "api_key",
              "value": "beac095463a1816cd30bb33c7a62531eb1437cbcba9ac456339630e69c6cf319"
            }
          ]
        },
        "options": {}
      },
      "id": "node-google-trends",
      "name": "Google Trends",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        -672,
        32
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "jsCode": "// Parse SerpAPI Google Trends related queries response\n// Expected structure: items[0].json contains serpapi response\nconst resp = items[0].json;\n// serpapi typically returns 'related_queries' or 'relatedSearches' depending on engine version\nlet related = [];\nif (resp.related_queries) related = resp.related_queries;\nelse if (resp.related_searches) related = resp.related_searches;\nelse if (resp.topics) related = resp.topics;\n\n// Flatten to items and keep top 3\nconst mapped = (Array.isArray(related) ? related : Object.values(related || {}))\n  .slice(0, 3)\n  .map(r => ({\n    source: 'google_trends',\n    title: r.query || r.topic || r.title || (r.value && r.value.query) || '',\n    description: r.description || '',\n    url: '',\n    tags: [],\n    score: r.value || r.formattedValue || r['query_share'] || null\n  }));\n\nreturn mapped.map(i => ({ json: i }));\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -384,
        32
      ],
      "id": "node-parse-trends",
      "name": "Parse Google Trends"
    },
    {
      "parameters": {
        "mode": "append",
        "appendFieldName": "combined_source"
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [
        -64,
        -112
      ],
      "id": "node-merge-sources",
      "name": "Merge Sources (Dev + Trends)"
    },
    {
      "parameters": {
        "jsCode": "// items contains combined items from Dev.to and Google Trends\n// Rank items: prefer devto items first (if any), then trends; but keep top 3 total\nconst all = items.map(it => it.json);\n// Basic ranking: devto items get +10 score, trends get 0; if score present use it\nall.forEach(i => {\n  i._score = 0;\n  if (i.source === 'devto') i._score += 10;\n  if (i.score) {\n    const s = parseFloat(String(i.score).replace(/[^0-9.]/g, ''));\n    if (!isNaN(s)) i._score += s;\n  }\n});\nall.sort((a,b) => (b._score||0) - (a._score||0));\nconst selected = all.slice(0,3);\nreturn selected.map(s => ({ json: s }));\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        224,
        -96
      ],
      "id": "node-select-top3",
      "name": "Select Top 3 Combined"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.mistral.ai/v1/chat/completions",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer EshjLXSAl716JiTDjJIoh5QB9ww2PDup"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"model\": \"codestral-2508\",\n  \"messages\": [\n    {\"role\":\"system\",\"content\":\"You are a skilled social media editor for technical audiences. From up to three candidate topics (Dev.to articles and Google Trends queries), choose the one that will make the most useful, engaging LinkedIn post for a professional audience. Produce output as strict JSON (no additional text) with these keys:\\n- headline: string (a bold heading, keep <= 80 chars, surround with ** for bold in Markdown)\\n- body: string (max 250 words). Include a short intro, 2-3 short paragraphs or bullets, and an explicit suggested @mention (as plain text like @OpenAI or @username — the LinkedIn API will treat it as text unless resolved).\\n- hashtags: array of up to 8 concise hashtags (strings)\\n- image_keywords: array of 2-3 comma-separated image search keywords (strings)\\n- source_chosen: object with keys { source: 'devto'|'google_trends', title, url, description, tags }\\nDo NOT include markdown code fences; just return valid JSON only. Be concise, professional, and add one call to action at the end of the body.\"},\n    {\"role\":\"user\",\"content\":\"Here are the up to 3 candidate items (JSON array). Choose the best and write the post about it. Items: {{$json}}\n\nWrite the JSON output exactly as requested.\"}\n  ],\n  \"max_tokens\": 800,\n  \"temperature\": 0.3\n}\n"
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        640,
        -160
      ],
      "id": "node-mistral-generate",
      "name": "Mistral - Generate Post"
    },
    {
      "parameters": {
        "jsCode": "const raw = items[0].json.choices && items[0].json.choices[0] && items[0].json.choices[0].message && items[0].json.choices[0].message.content;\nif (!raw) throw new Error('No content returned from Mistral');\nlet clean = raw.replace(/```json/g,'').replace(/```/g,'').trim();\nlet parsed;\ntry { parsed = JSON.parse(clean); } catch(e){\n  throw new Error('Failed to parse Mistral JSON: '+e.message+'\\nRaw:'+clean);\n}\n// Normalize fields\nreturn [{ json: {\n  headline: parsed.headline,\n  body: parsed.body,\n  hashtags: Array.isArray(parsed.hashtags)? parsed.hashtags : (typeof parsed.hashtags==='string'? parsed.hashtags.split(',').map(h=>h.trim()):[]),\n  image_keywords: Array.isArray(parsed.image_keywords)? parsed.image_keywords : (typeof parsed.image_keywords==='string'? parsed.image_keywords.split(',').map(s=>s.trim()):[]),\n  source_chosen: parsed.source_chosen || {}\n}}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        944,
        -160
      ],
      "id": "node-parse-mistral",
      "name": "ParseMistralOutput"
    },
    {
      "parameters": {
        "url": "https://api.unsplash.com/search/photos",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "query",
              "value": "={{ $json.image_keywords && $json.image_keywords.length ? $json.image_keywords.join(', ') : 'technology' }}"
            },
            {
              "name": "per_page",
              "value": "1"
            },
            {
              "name": "orientation",
              "value": "landscape"
            }
          ]
        },
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Client-ID gMKB9dk0ZCh3CQtFTo9U6C4kkSR-lbX99vvDIW8lYZg"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        1216,
        -160
      ],
      "id": "node-unsplash-search",
      "name": "Unsplash - Search Photo"
    },
    {
      "parameters": {
        "jsCode": "const r = items[0].json.results && items[0].json.results[0];\nif (!r) throw new Error('No image found');\nreturn [{ json: {\n  image_url: r.urls.full,\n  thumb_url: r.urls.small,\n  alt_description: r.alt_description || 'Image',\n  photographer_name: r.user && r.user.name,\n  photographer_link: r.user && r.user.links && r.user.links.html,\n  unsplash_download_link: r.links && r.links.download\n}}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1488,
        -160
      ],
      "id": "node-parse-unsplash",
      "name": "Parse Unsplash Image"
    },
    {
      "parameters": {
        "url": "={{$json[\"image_url\"]}}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "file"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        1760,
        -160
      ],
      "id": "node-download-image",
      "name": "Downloading the Image"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.linkedin.com/v2/assets?action=registerUpload",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer AQWUUXkE3HoMga_XLMNqP90Y6D2yCSHTzaAgHDREh9E-JDMNLSKzX0VdvuCULeGfwC5fqZO47d9R1bxRyqVNkQbSR9YdKSKSBc8te0BTui0EKNrw9r9Xerb8RAHwxOaDi3xPvZfzwcaW7EvXCCjVP22yB1a3ZMM5ZqyuPUQFGLpJtGgI0ZJRA-MbsFYnqMWm6zyVwpXJCgJJl7n97WTS8vPtJV8hIorMoo_t0mwpSkgVVPFiGxz2KhbUeRhZTJJyGkadjwgGwOFvDQnAH8FeTgoiVMXXhNTrMq8-z4QbnO5XM1mMksIXKEnbKF5gUt6oJJT6Luyf6Svij5gmXGUhRF4V_ReHzw"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "{\n \"registerUploadRequest\": {\n \"owner\": \"urn:li:person:xoHd3yIDO2\",\n \"recipes\": [\"urn:li:digitalmediaRecipe:feedshare-image\"],\n \"serviceRelationships\": [\n {\n \"identifier\": \"urn:li:userGeneratedContent\",\n \"relationshipType\": \"OWNER\"\n }\n ],\n \"supportedUploadMechanism\": [\"SYNCHRONOUS_UPLOAD\"]\n }\n}\n",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        2016,
        -160
      ],
      "id": "node-linkedin-register-upload",
      "name": "LinkedIn - Register Upload"
    },
    {
      "parameters": {
        "jsCode": "// Map registerUpload response to grab uploadUrl and asset\nconst value = items[0].json;\nlet uploadUrl = null;\ntry {\n  uploadUrl = value.value.uploadMechanism['com.linkedin.digitalmedia.uploading.MediaUploadHttpRequest'].uploadUrl;\n} catch (e) {\n  uploadUrl = value.value && value.value.uploadUrl || null;\n}\nconst asset = value.value && value.value.asset || null;\nreturn [{ json: { uploadUrl, asset } }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2320,
        -160
      ],
      "id": "node-extract-uploadinfo",
      "name": "Extract Upload Info"
    },
    {
      "parameters": {
        "method": "PUT",
        "url": "={{ $json.uploadUrl }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "name",
              "value": "Content-Type"
            },
            {
              "name": "value",
              "value": "image/jpeg"
            }
          ]
        },
        "sendBody": true,
        "contentType": "binaryData",
        "inputDataFieldName": "data",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        2560,
        -160
      ],
      "id": "node-upload-image-linkedin",
      "name": "Upload Image to LinkedIn"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.linkedin.com/v2/ugcPosts",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Authorization",
              "value": "Bearer AQWHNOGJJ1y-X0GLGMaDHH45Y84t4OhtvRkvMZPL3cseAp4Y0Vb-IsSceDNhsrpE7I8MUo893YOVfXvkiH-rCiX03BaXVBVEHxaOwLna7m174XazNWQdAR1OnrgSLiDY-EjZz6QVW5J5H97aKWRyzAg6Uft2_n8E09RPd-CvyF-FvxyEUfvw82a3Hxepyzml86I8MVf7OtfqvlHpF4EGFkP_CdMXPNLBxaj5PIcyQRTwDx3iwrrK3B4b8cK7Y09t79bVkVFnElHDWdt7zyrc7m8NRvyQZMDCHptqreavKT_rBCALy8bxPqBwtZ2YSahSmL0vrpkD0da88VLAQkKkdX3VllOyhA"
            },
            {
              "name": "X-Restli-Protocol-Version",
              "value": "2.0.0"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"author\": \"urn:li:person:xoHd3yIDO2\",\n  \"lifecycleState\": \"PUBLISHED\",\n  \"specificContent\": {\n    \"com.linkedin.ugc.ShareContent\": {\n      \"shareCommentary\": {\n        \"text\": \"{{$json.body}}\\n\\n{{$json.hashtags && Array.isArray($json.hashtags) ? $json.hashtags.join(' ') : $json.hashtags}}\"\n      },\n      \"shareMediaCategory\": \"IMAGE\",\n      \"media\": [\n        {\n          \"status\": \"READY\",\n          \"description\": { \"text\": \"{{$json.image_keywords && Array.isArray($json.image_keywords) ? $json.image_keywords.join(', ') : $json.image_keywords}}\" },\n          \"media\": \"{{$json.asset}}\",\n          \"title\": { \"text\": \"{{$json.headline}}\" }\n        }\n      ]\n    }\n  },\n  \"visibility\": {\n    \"com.linkedin.ugc.MemberNetworkVisibility\": \"PUBLIC\"\n  }\n}\n",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        2880,
        -160
      ],
      "id": "node-linkedin-create-post",
      "name": "LinkedIn - Create Post"
    },
    {
      "parameters": {
        "mode": "passThrough"
      },
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        3104,
        -160
      ],
      "id": "node-end",
      "name": "Done"
    }
  ],
  "connections": {
    "node-schedule-trigger": {
      "main": [
        [
          {
            "node": "node-devto-get-top",
            "type": "main",
            "index": 0
          },
          {
            "node": "node-google-trends",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "node-devto-get-top": {
      "main": [
        [
          {
            "node": "node-pick-top-devto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "node-pick-top-devto": {
      "main": [
        [
          {
            "node": "node-merge-sources",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "node-google-trends": {
      "main": [
        [
          {
            "node": "node-parse-trends",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "node-parse-trends": {
      "main": [
        [
          {
            "node": "node-merge-sources",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "node-merge-sources": {
      "main": [
        [
          {
            "node": "node-select-top3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "node-select-top3": {
      "main": [
        [
          {
            "node": "node-mistral-generate",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "node-mistral-generate": {
      "main": [
        [
          {
            "node": "node-parse-mistral",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "node-parse-mistral": {
      "main": [
        [
          {
            "node": "node-unsplash-search",
            "type": "main",
            "index": 0
          },
          {
            "node": "node-linkedin-create-post",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "node-unsplash-search": {
      "main": [
        [
          {
            "node": "node-parse-unsplash",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "node-parse-unsplash": {
      "main": [
        [
          {
            "node": "node-download-image",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "node-download-image": {
      "main": [
        [
          {
            "node": "node-linkedin-register-upload",
            "type": "main",
            "index": 0
          },
          {
            "node": "node-extract-uploadinfo",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "node-linkedin-register-upload": {
      "main": [
        [
          {
            "node": "node-extract-uploadinfo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "node-extract-uploadinfo": {
      "main": [
        [
          {
            "node": "node-upload-image-linkedin",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "node-upload-image-linkedin": {
      "main": [
        [
          {
            "node": "node-linkedin-create-post",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "node-linkedin-create-post": {
      "main": [
        [
          {
            "node": "node-end",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {},
  "name": "Enhanced DevTo + GoogleTrends → Mistral → LinkedIn"
}
